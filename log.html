<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FreeFit â€“ Log Workout</title>
  <link rel="stylesheet" href="css/styles.css" />
  <script src="https://cdn.jsdelivr.net/npm/lucide@0.264.0/dist/umd/lucide.min.js"></script>
  <style>
    /* Page-specific styles */
    #entries {
      margin-top: var(--space-md);
      border-top: 1px solid var(--color-border);
      padding-top: var(--space-md);
    }
    .entry-row {
      display: grid;
      grid-template-columns: 2fr 1fr 1fr 1fr auto;
      gap: var(--space-xs);
      align-items: center;
      margin-bottom: var(--space-sm);
    }
    .remove-entry {
      background: none;
      border: none;
      color: var(--color-accent-alt);
      font-size: 1.25rem;
      cursor: pointer;
      line-height: 1;
    }
    .field label {
      font-weight: bold;
      margin-top: var(--space-md);
      display: block;
    }
    .field input,
    .field select,
    .field textarea {
      width: 100%;
      padding: var(--space-sm);
      margin-top: var(--space-xs);
      border: none;
      border-radius: var(--radius-md);
      background: var(--color-bg-light);
      color: var(--color-text);
      font-size: var(--fz-base);
    }
  </style>
</head>
<body>
  <!-- Navbar -->
  <nav>
    <a href="landing.html"><i data-lucide="home"></i><span>Home</span></a>
    <a href="profile.html"><i data-lucide="user"></i><span>Profile</span></a>
    <a href="workouts.html"><i data-lucide="dumbbell"></i><span>Workouts</span></a>
    <a href="log.html" class="active"><i data-lucide="pencil"></i><span>Log Entry</span></a>
    <a href="metrics.html"><i data-lucide="bar-chart"></i><span>Metrics</span></a>
  </nav>

  <!-- Main Content -->
  <main class="container">
    <div class="card" style="max-width: 600px;">
      <h2 style="margin-bottom: var(--space-md);">Log a New Workout</h2>
      <form id="logForm" style="display: flex; flex-direction: column; gap: var(--space-md);">
        <div class="field">
          <label for="type">Workout Type</label>
          <select id="type" required>
            <option value="">â€” Select type â€”</option>
            <option value="push">Push</option>
            <option value="pull">Pull</option>
            <option value="legs">Legs</option>
            <option value="core">Core</option>
            <option value="full body">Full Body</option>
            <option value="cardio">Cardio</option>
            <option value="rest">Rest</option>
          </select>
        </div>
        <div class="field">
          <label for="date">Date</label>
          <input type="date" id="date" required />
        </div>
        <div class="field">
          <label for="notes">Session Notes</label>
          <textarea id="notes" rows="2" placeholder="Howâ€™d it go?"></textarea>
        </div>

        <div id="entries"></div>
        <button type="button" class="secondary-btn" id="addEntry">+ Add Exercise</button>
        <button type="submit" class="primary-btn" id="saveWorkout">Save Workout</button>
        <p id="status"></p>
      </form>
    </div>
  </main>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";
    const supabase = createClient(
      'https://mgskqqwxvnxyasuksxvp.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1nc2txcXd4dm54eWFzdWtzeHZwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDYyNjc0NTQsImV4cCI6MjA2MTg0MzQ1NH0.BOqV1UvJIA5EzP9FsFWoI_F229nswzmG5WHkXdz4ItI'
    );

    let exercises = [];
    let userId = null;

    document.addEventListener('DOMContentLoaded', init);

    async function init() {
      // Auth check
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) return window.location.replace('login.html');
      userId = session.user.id;

      // Load exercises
      const { data, error } = await supabase.from('exercises').select('id, exercise_name');
      if (!error) exercises = data;

      // Default date
      document.getElementById('date').valueAsDate = new Date();

      // Bind events
      document.getElementById('addEntry').addEventListener('click', addEntryRow);
      document.getElementById('logForm').addEventListener('submit', handleSubmit);

      // First entry row
      addEntryRow();
      if (window.lucide) lucide.createIcons();
    }

    function addEntryRow() {
      const container = document.getElementById('entries');
      const row = document.createElement('div');
      row.className = 'entry-row';
      row.innerHTML = `
        <select class="exercise_id" required>
          <option value="">â€” choose exercise â€”</option>
          ${exercises.map(e => `<option value="${e.id}">${e.exercise_name}</option>`).join('')}
        </select>
        <input type="number" class="sets" placeholder="Sets" min="1" required />
        <input type="number" class="reps" placeholder="Reps" min="1" required />
        <input type="number" class="weight" placeholder="Weight" min="0" step="0.1" />
        <button type="button" class="remove-entry">&times;</button>
      `;
      row.querySelector('.remove-entry').addEventListener('click', () => row.remove());
      container.appendChild(row);
    }

    async function handleSubmit(e) {
      e.preventDefault();
      const type = document.getElementById('type').value;
      const date = document.getElementById('date').value;
      const notes = document.getElementById('notes').value.trim();

      const rows = Array.from(document.querySelectorAll('.entry-row')).map(r => ({
        exercise_id: r.querySelector('.exercise_id').value,
        sets: parseInt(r.querySelector('.sets').value, 10),
        reps: parseInt(r.querySelector('.reps').value, 10),
        weight: parseFloat(r.querySelector('.weight').value) || 0
      })).filter(r => r.exercise_id);

      if (!rows.length) return showStatus('Add at least one exercise!', 'var(--color-accent-alt)');

      // Insert workout
      const { data: w, error: wErr } = await supabase.from('workouts').insert([{ user_id: userId, date, type, notes }]).select('id').single();
      if (wErr) return showStatus('Failed to save workout.', 'var(--color-accent-alt)');

      // Insert entries
      const { error: eErr } = await supabase.from('workout_entries').insert(
        rows.map(r => ({ workout_id: w.id, ...r }))
      );
      if (eErr) return showStatus('Failed to save exercises.', 'var(--color-accent-alt)');

      showStatus('Workout logged! ðŸŽ‰', 'var(--color-accent)');
    }

    function showStatus(msg, color) {
      const st = document.getElementById('status');
      st.textContent = msg;
      st.style.color = color;
    }
  </script>
</body>
</html>
