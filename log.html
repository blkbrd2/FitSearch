<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FreeFit â€“ Log Workout</title>
  <link rel="stylesheet" href="css/styles.css" />
  <link rel="stylesheet" href="css/responsive.css" />
  <script src="https://cdn.jsdelivr.net/npm/lucide@0.264.0/dist/umd/lucide.min.js"></script>
  <style>
    /* Page-specific styles */
    #entries {
      margin-top: var(--space-md);
      border-top: 1px solid var(--color-border);
      padding-top: var(--space-md);
    }
    .entry-row {
      display: grid;
      grid-template-columns: 2fr 1fr 1fr 1fr auto;
      gap: var(--space-sm);
      align-items: center;
      margin-bottom: var(--space-sm);
    }
    .entry-row input,
    .entry-row button.remove-entry {
      font-size: var(--fz-base);
    }
    button.remove-entry {
      background: transparent;
      color: var(--color-accent-alt);
      border: none;
      font-size: 1.25rem;
      cursor: pointer;
    }
    /* Date picker full-width and vertically centered */
    .field input[type="date"] {
      width: 100%;
      padding: 0 var(--space-sm);
      height: 2.5rem;
      line-height: 2.5rem;
      margin-top: var(--space-xs);
    }
  </style>
</head>
<body>
  <!-- Navbar -->
  <nav>
    <a href="landing.html"><i data-lucide="home"></i><span>Home</span></a>
    <a href="profile.html"><i data-lucide="user"></i><span>Profile</span></a>
    <a href="workouts.html"><i data-lucide="dumbbell"></i><span>Workouts</span></a>
    <a href="exercise_search.html"><i data-lucide="search"></i><span>Exercises</span></a>
    <a href="log.html" class="active"><i data-lucide="pencil"></i><span>Log Entry</span></a>
    <a href="metrics.html"><i data-lucide="bar-chart"></i><span>Metrics</span></a>
  </nav>

  <!-- Global datalist for searchable exercises -->
  <datalist id="exerciseList"></datalist>

  <!-- Main Content -->
  <main class="container">
    <div class="card" style="max-width: 600px;">
      <h2 style="margin-bottom: var(--space-md);">Log a New Workout</h2>
      <form id="logForm" style="display: flex; flex-direction: column; gap: var(--space-md);">
        <div class="field">
          <label for="date">Date</label>
          <input type="date" id="date" required />
        </div>
        <div class="field">
          <label for="type">Workout Type</label>
          <select id="type" class="input" required>
            <option value="push">Push</option>
            <option value="pull">Pull</option>
            <option value="legs">Legs</option>
            <option value="core">Core</option>
          </select>
        </div>
        <div class="field">
          <label for="notes">Session Notes</label>
          <textarea id="notes" rows="2" placeholder="Howâ€™d it go?"></textarea>
        </div>

        <!-- Exercise entries inserted here -->
        <div id="entries"></div>
        <button type="button" class="secondary-btn" id="addEntry">+ Add Exercise</button>
        <button type="submit" class="primary-btn" id="saveWorkout">Save Workout</button>
        <p id="status"></p>
      </form>
    </div>
  </main>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";
    const supabase = createClient(
      'https://mgskqqwxvnxyasuksxvp.supabase.co',
      'YOUR_SUPABASE_ANON_KEY'
    );

    let exercises = [];
    let userId = null;
    let editingWorkoutId = null;

    document.addEventListener('DOMContentLoaded', init);

    async function init() {
      // Auth check
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) return window.location.replace('login.html');
      userId = session.user.id;

      // Load master exercise list
      const { data: exData, error: exErr } = await supabase
        .from('exercises').select('id, exercise_name');
      if (!exErr) {
        exercises = exData;
        const dl = document.getElementById('exerciseList');
        exercises.forEach(e => {
          const opt = document.createElement('option');
          opt.value = e.exercise_name;
          dl.appendChild(opt);
        });
      }

      // Wire up form controls
      document.getElementById('date').valueAsDate = new Date();
      document.getElementById('addEntry').addEventListener('click', addEntryRow);
      document.getElementById('logForm').addEventListener('submit', handleSubmit);

      // Check for ?edit=ID
      const params = new URLSearchParams(window.location.search);
      const editId = params.get('edit');
      if (editId) {
        editingWorkoutId = editId;
        document.getElementById('saveWorkout').textContent = 'Update Workout';
        await loadWorkoutForEdit(editId);
      } else {
        addEntryRow();
      }

      if (window.lucide) lucide.createIcons();
    }

    async function loadWorkoutForEdit(id) {
      // Fetch workout metadata
      const { data: workout, error: wErr } = await supabase
        .from('workouts').select('date, type, notes').eq('id', id).single();
      if (wErr) return showStatus('Failed to load workout.', 'var(--color-accent-alt)');

      // Populate the form fields
      document.getElementById('date').value = workout.date.split('T')[0];
      document.getElementById('type').value = workout.type;
      document.getElementById('notes').value = workout.notes || '';

      // Fetch and render its entries
      const { data: entries, error: eErr } = await supabase
        .from('workout_entries').select('exercise_id, sets, reps, weight').eq('workout_id', id);
      if (eErr) return showStatus('Failed to load exercises.', 'var(--color-accent-alt)');

      const container = document.getElementById('entries');
      container.innerHTML = '';  // clear any default rows

      entries.forEach(entry => {
        addEntryRow();
        const rows = container.querySelectorAll('.entry-row');
        const row = rows[rows.length - 1];
        const ex = exercises.find(e => e.id === entry.exercise_id);
        row.querySelector('.exercise_search').value = ex.exercise_name;
        row.querySelector('.exercise_id').value    = entry.exercise_id;
        row.querySelector('.sets').value           = entry.sets;
        row.querySelector('.reps').value           = entry.reps;
        row.querySelector('.weight').value         = entry.weight;
      });
    }

    async function handleSubmit(e) {
      e.preventDefault();
      const type  = document.getElementById('type').value;
      const date  = document.getElementById('date').value;
      const notes = document.getElementById('notes').value.trim();
      const rows  = Array.from(document.querySelectorAll('.entry-row')).map(r => ({
        exercise_id: r.querySelector('.exercise_id').value,
        sets:    parseInt(r.querySelector('.sets').value, 10),
        reps:    parseInt(r.querySelector('.reps').value, 10),
        weight:  parseFloat(r.querySelector('.weight').value) || 0,
      }));

      if (editingWorkoutId) {
        // --- UPDATE EXISTING WORKOUT ---
        const { error: wErr } = await supabase
          .from('workouts').update({ date, type, notes }).eq('id', editingWorkoutId);
        if (wErr) return showStatus('Failed to update workout.', 'var(--color-accent-alt)');

        // Remove old entries
        const { error: delErr } = await supabase
          .from('workout_entries').delete().eq('workout_id', editingWorkoutId);
        if (delErr) return showStatus('Failed to clear old entries.', 'var(--color-accent-alt)');

        // Insert new entries
        const { error: eErr } = await supabase
          .from('workout_entries')
          .insert(rows.map(r => ({ workout_id: editingWorkoutId, ...r })));
        if (eErr) return showStatus('Failed to save exercises.', 'var(--color-accent-alt)');

        showStatus('Workout updated! ðŸŽ‰', 'var(--color-accent)');
      } else {
        // --- CREATE NEW WORKOUT ---
        const { data: w, error } = await supabase
          .from('workouts')
          .insert({ user_id: userId, date, type, notes })
          .select('id')
          .single();
        if (error) return showStatus('Failed to save workout.', 'var(--color-accent-alt)');

        const { error: eErr } = await supabase
          .from('workout_entries')
          .insert(rows.map(r => ({ workout_id: w.id, ...r })));
        if (eErr) return showStatus('Failed to save exercises.', 'var(--color-accent-alt)');

        showStatus('Workout logged! ðŸŽ‰', 'var(--color-accent)');
      }
    }

    function showStatus(msg, color) {
      const st = document.getElementById('status');
      st.textContent = msg;
      st.style.color   = color;
    }

    function addEntryRow() {
      const container = document.getElementById('entries');
      const row = document.createElement('div');
      row.className = 'entry-row';
      row.innerHTML = `
        <input type="text" class="exercise_search" list="exerciseList" placeholder="â€” choose exercise â€”" required />
        <input type="hidden" class="exercise_id" />
        <input type="number" class="sets" placeholder="Sets" min="1" required />
        <input type="number" class="reps" placeholder="Reps" min="1" required />
        <input type="number" class="weight" placeholder="Weight" min="0" step="0.1" />
        <button type="button" class="remove-entry">Ã—</button>
      `;
      const search = row.querySelector('.exercise_search');
      const hidden = row.querySelector('.exercise_id');
      search.addEventListener('change', () => {
        const found = exercises.find(e => e.exercise_name === search.value);
        hidden.value = found ? found.id : '';
      });
      row.querySelector('.remove-entry').addEventListener('click', () => row.remove());
      container.appendChild(row);
    }
  </script>
</body>
</html>
